{% load chat %}
<script>
    function scrollToBottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    const {createApp} = Vue

    const conversationapp = createApp({
        delimiters: ['[[', ']]'],
        data () {
            return {
                messages: [],
                conversation_id: {% if conversation %}{{ conversation.id }}{% else %}'global'{% endif %},
                content: '',
                tweeker: '{{ request.user.username }}',
                formatted_time: 'Now',
                avatar: '{% if request.user.twikkerprofile.avatar %}{{ request.user.twikkerprofile.avatar.url }}{% endif %}'
            }
        },
        mounted() {
            this.getMessages();
        },
        methods: {
            getMessages(){
                fetch('/api/messages/' + this.conversation_id)
                .then(response => response.json())
                .then(data => {
                    console.log("data is", data)
                    for (let i = 0; i < data.messages.length; i++) {
                        this.messages.push(data.messages[i])
                    }
                })
                .then(() => {
                    scrollToBottom();
                })
            },
            submitMessage() {
                if (this.content.length > 0) {
                    let message = {
                        'content': this.content,
                        'tweeker_name': this.tweeker,
                        'formatted_time': this.formatted_time,
                        'avatar_url': this.avatar,
                        'conversation_id': {% if conversation %}{{ conversation.id }}{% else %}null{% endif %},
                    };
                    chatSocket.send(JSON.stringify(message));
                    this.content = '';

                }
            },
            getClass(tweeker) {
                if (tweeker == '{{ request.user.username }}') {
                    return 'is-pulled-right right-margin palegreen media messagebox';
                } else {
                    return 'message-left media messagebox';
                }
            },
        }
    }).mount("#conversationapp")
</script>