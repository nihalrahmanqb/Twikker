{% extends 'core/base.html' %}
{% load humanize %}
{% block content %}
    <div class="container is-fluid" id="conversationapp">
<<<<<<< HEAD
                <h1 class="title">Global Chat</h1>
                <div class="globalbox" id="globalchat">
                    {% for message in messages %}
                        <div class="tweek">
                            <article class="media box">
                                <figure class="media-left">
                                    <p class="image is-3by4 is-32x32">
                                        {% if message.created_by.twikkerprofile.avatar %}
                                            <img class="is-rounded" src="{{ message.created_by.twikkerprofile.avatar.url }}">
                                        {% endif %}
                                    </p>
                                </figure>

                                <div class="media-content">
                                    <div class="content">
                                        <p>
                                            <strong><a href="{% url 'twikkerprofile' message.created_by %}">{{ message.created_by.username }}</a></strong>
                                            <small>{{ message.created_at|naturaltime }} </small>
                                            <br>
                                            <span class="subtitle">{{ message.content }}</span>
                                        </p>
                                    </div>
                                </div>
                            </article>
                        </div>
                    {% endfor %}

                    <div class="tweek" v-for="message in messages">
                        <article class="media box">
                            <figure class="media-left">
                                <p class="image is-3by4 is-32x32">
                                    <img class="is-rounded" :src="message.avatar">
                                </p>
                            </figure>

                            <div class="media-content" id="new_message">
                                <div class="content">
                                    <p>
                                        <strong>[[ message.tweeker ]]</strong>
                                        <small>[[ message.created_at ]]</small>
                                        <br>
                                        <span class="subtitle">[[ message.content ]]</span>
                                    </p>
                                </div>
=======
        <h1 class="title">Global Chat</h1>
        <div class="globalbox">
            {% for message in messages %}
                <div class="tweek">
                    <article class="media box">
                        <figure class="media-left">
                            <p class="image is-3by4 is-32x32">
                                {% if message.created_by.twikkerprofile.avatar %}
                                    <img class="is-rounded" src="{{ message.created_by.twikkerprofile.avatar.url }}">
                                {% endif %}
                            </p>
                        </figure>
                        <div class="media-content">
                            <div class="content">
                                <p>
                                    <strong><a href="{% url 'twikkerprofile' message.created_by %}">{{ message.created_by.username }}</a></strong>
                                    <small>{{ message.created_at|naturaltime }} </small>
                                    <br>
                                    <span class="subtitle">{{ message.content }}</span>
                                </p>
>>>>>>> 9a7292ad5b4cb918afd884741101f2e6521cbf91
                            </div>
                        </div>
                    </article>
                </div>
            {% endfor %}
            <div class="tweek" v-for="message in messages">
                <article class="media box">
                    <figure class="media-left">
                        <p class="image is-3by4 is-32x32">
                            <img class="is-rounded" :src="message.avatar">
                        </p>
                    </figure>
                    <div class="media-content">
                        <div class="content">
                            <p>
                                <strong>[[ message.tweeker ]]</strong>
                                <small>[[ message.created_at ]]</small>
                                <br>
                                <span class="subtitle">[[ message.content ]]</span>
                            </p>
                        </div>
                    </div>
                </article>
            </div>
        </div>
        <form class="top_margin_text" v-on:submit.prevent="submitMessage()">
            <div class="field">
                <div class="control">
                    <textarea class="textarea" v-model="content" placeholder="Your message..."></textarea>
                </div>
            </div>

            <div class="field">
                <div class="control">
                    <button class="button is-primary">Send</button>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{{ request.user|json_script:"json-username" }}

{% block script %}
<script>
    function scrollToBottom(new_message=false) {
        let objDiv = document.getElementById("globalchat");
        objDiv.scrollTop= objDiv.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        scrollToBottom();
    });

    const conversation = 'global'
    const userName = JSON.parse(document.getElementById('json-username'));

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'global'
        + '/'
    );

    chatSocket.onmessage = function(e) {
        console.log('onmessage');
        const data = JSON.parse(e.data);
        console.log("data", data);
        conversationapp.messages.push(data);
        setTimeout(() => {
            scrollToBottom();
        }, 0);
    };

    var conversationapp = new Vue({
        el: '#conversationapp',
        delimiters: ['[[', ']]'],
        data () {
            return {
                messages: [],
                content: '',
                tweeker: '{{ request.user.username }}',
                created_at: 'Now',
                avatar: '{% if request.user.twikkerprofile.avatar %}{{ request.user.twikkerprofile.avatar.url }}{% endif %}'
            }
        },
        methods: {
            submitMessage() {
                if (this.content.length > 0) {
                    var message = {
                        'content': this.content,
                        'tweeker': this.tweeker,
                        'created_at': this.created_at,
                        'avatar': this.avatar,
                        'conversation_id': null
                    };
                    chatSocket.send(JSON.stringify(message));
                    this.content = '';

                }
            },
        }
    })
</script>
{% endblock %}