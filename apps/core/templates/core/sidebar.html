{% load chat %}
{% if request.user.is_authenticated %}
<div class="column sidebar is-2">
    <a href="{% url 'feed' %}" class="navbar-item"><span class="white">Feed</span></a>
    <a href="{% url 'users' %}" class="navbar-item"><span class="white">All Users</span></a>
    <a href="{% url 'global' %}" class="navbar-item"><span class="white">Global Chat</span></a>
    <a id="notifications" href="{% url 'notifications' %}" class="navbar-item"><span class="white">Notifications ({{ notifications.count }})</span></a>
    <a href="{% url 'conversations' %}" class="navbar-item"><span class="white">Conversations</span></a>
    <a href="{% url 'twikkerprofile' request.user.username %}" class="navbar-item"><span class="white">Profile</span></a>
    <a href="{% url 'edit_profile' %}" class="navbar-item"><span class="white">Edit profile</span></a>
</div>  
{% else %}
<div class="column sidebar is-2"></div>
{% endif %}


<script>
    const followSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'follow/'
    );

    const tweekSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'tweek/'
    );

    const likeSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'like/'
    );

    {% if conversation %}
        {% get_chat_user_id conversation request.user.id as userid %}
    {% endif %}

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'chat/'
        + '{% if conversation %}{{ userid }}{% else %}0{% endif %}'
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("datacpmn", data);
        conversationapp.messages.push(data);
        setTimeout(() => {
            scrollToBottom();
        }, 0);

        console.log("to_user_idto_user_id", data.to_user_id, {{ request.user.id }});

        if (data.to_user_id == {{ request.user.id }}) {
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
        }

    };

    followSocket.onmessage = function(e) {
        notifications_el = document.querySelector('#notifications').innerHTML
        notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
        document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
    };

    likeSocket.onmessage = function(e) {
        notifications_el = document.querySelector('#notifications').innerHTML
        notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
        document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
    };

    tweekSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        body = data.body
        //check if the user is tagged in the tweek
        if (body.includes("@{{ request.user.username }}")){
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
        }
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("asdasdasdadsads", data);
        if (data.to_user_id == {{ request.user.id }}) {
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
        }

    };
</script>