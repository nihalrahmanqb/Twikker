{% load chat %}
{% load static %}
{% if request.user.is_authenticated %}

<a href="{% url 'frontpage' %}">
    <p>
        <img src="{% static 'img/cp.jpg' %}">
    </p>
</a>
<div id="navBar">
    <div>
        <div>
            <div>
                <form method="get" action="{%  url 'search' %}">
                    <div>
                        <div>
                            <input type="text" name="query" placeholder="Search">
                        </div>
                        <div>
                            <button>Search</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div>
            <a href="{% url 'feed' %}"><span>Feed</span></a>
            <a href="{% url 'users' %}"><span>All Users</span></a>
            <a href="{% url 'global' %}"><span>Global Chat</span></a>
            <a id="notifications" href="{% url 'notifications' %}"><span>Notifications ({{ notifications.count }})</span></a>
            <a href="{% url 'conversations' %}"><span>Conversations</span></a>
            <a href="{% url 'twikkerprofile' request.user.username %}"><span>Profile</span></a>
            <a href="{% url 'edit_profile' %}"><span>Edit profile</span></a>
        </div>
        <div>
            <div>
                {% if request.user.is_authenticated %}
                    <a href="{% url 'logout' %}">Log out</a>
                {% else %}
                    <a href="{% url 'signup' %}">Sign Up</a>
                    <a href="{% url 'login' %}">Log in</a>
                {% endif %}
            </div>
        </div>
    </div>    
{% else %}
<div>
    <div>
        <div>
                <a href="{% url 'signup' %}">Sign Up</a>
                <a href="{% url 'login' %}">Log in</a>
        </div>
    </div>
</div>
{% endif %}


<script>
    const followSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'follow/'
    );

    const tweekSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'tweek/'
    );

    const likeSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'like/'
    );

    {% if conversation %}
        {% get_chat_user_id conversation request.user.id as userid %}
    {% endif %}

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'chat/'
        + '{% if conversation %}{{ userid }}{% else %}0{% endif %}'
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        conversationapp.messages.push(data);
        setTimeout(() => {
            scrollToBottom();
        }, 0);

        if (data.to_user_id == {{ request.user.id }}) {
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
        }

    };

    followSocket.onmessage = function(e) {
        notifications_el = document.querySelector('#notifications').innerHTML
        notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
        document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
    };

    likeSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.tweek_owner === '{{ request.user.username }}') {
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
        }
    };

    tweekSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        body = data.body
        //check if the user is tagged in the tweek
        if (body.includes("@{{ request.user.username }}")){
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
        }
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        document.querySelector("#chatcontainer")
        try{
            conversationapp.messages.push(data);
            setTimeout(() => {
                scrollToBottom();
            }, 0);
        }catch{}
        if (data.to_user_id == {{ request.user.id }}) {
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white">Notifications (' + (notification_count + 1) + ')</span>'
        }

    };
</script>