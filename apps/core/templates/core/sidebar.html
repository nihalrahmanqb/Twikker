{% load chat %} 
{% load static %} 
{% if request.user.is_authenticated %}
<div class="sticky top-0 left-0 px-2 h-screen bg-white border-solid border-r-2 border-gray-100">
    <div class="flex flex-col justify-between h-screen">
        <div class="flex flex-col justify-center">
            <div class="flex py-1">
                <a class="flex justify-center text-black font-semibold text-2xl p-2 hover:bg-green-200 hover:rounded-full " href="{% url 'feed' %} ">
                    <div>
                        <i class="text-5xl fa-solid fa-ankh"></i>
                    </div>
                </a>
            </div>
            <div class="flex py-1">
                <a class="flex justify-center text-black font-semibold text-2xl p-2 hover:bg-gray-200 hover:rounded-full " href="{% url 'feed' %} ">
                    <div>
                        <i class="w-10 text-3xl py-2 fa-solid  fa-house"></i>
                    </div>
                    <span class="m-auto mx-3">Página Inicial</span>
                </a>
            </div>
            <div class="flex py-1">
                <a class="flex text-black font-semibold text-2xl p-2 hover:bg-gray-200 hover:rounded-full " href="{% url 'notifications' %} ">
                    <div>
                        <i class="w-10 text-3xl py-2 fa-solid fa-bell"></i>
                    </div>
                    <span id="notifications" class="m-auto mx-3">Notificações</span>
                </a>
            </div>
            <div class="flex py-1">
                <a class="flex text-black font-semibold text-2xl p-2 hover:bg-gray-200 hover:rounded-full " href="{% url 'users' %} ">
                    <div>
                        <i class="w-10 text-3xl py-2 fa-solid fa-users"></i>
                    </div>
                    <span class="m-auto mx-3">All users</span>
                </a>
            </div>
            <div class="flex py-1">
                <a class="flex text-black font-semibold text-2xl p-2 hover:bg-gray-200 hover:rounded-full " href="{% url 'global' %} ">
                    <div>
                        <i class="w-10 text-3xl py-2 fa-solid fa-earth-americas"></i>
                    </div>
                    <span class="break-keep m-auto mx-3">Global chat</span>
                </a>
            </div>
            <div class="flex py-1">
                <a class="flex text-black font-semibold text-2xl p-2 hover:bg-gray-200 hover:rounded-full " href="{% url 'conversations' %} ">
                    <div>
                        <i class="w-10 text-3xl py-2 fa-solid fa-comments"></i>
                    </div>
                    <span class="m-auto mx-3">Conversations</span>
                </a>
            </div>
            <div class="flex py-1">
                <a class="flex text-black font-semibold text-2xl p-2 hover:bg-gray-200 hover:rounded-full " href="{% url 'twikkerprofile' request.user.username %} ">
                    <div>
                        <i class="w-10 text-3xl py-2 fa-solid fa-user"></i>
                    </div>
                    <span class="m-auto mx-3">Perfil</span>
                </a>
            </div>
        </div>
        <div class="flex flex-row justify-between w-full my-3 p-1 hover:bg-gray-200 hover:rounded-full">
            <div class="flex p-3">
                <img class="rounded-full h-12 w-12 m-auto" src="{% if request.user.twikkerprofile.avatar %}{{ request.user.twikkerprofile.avatar.url }}{% endif %} ">
                <h1 class="ml-1 text-black font-semibold ">{{ user.username }}</h1>
            </div>
            <div class="flex">
                <a class="text-black text-2xl m-auto p-2" style="margin-left: auto; " href="{% url 'edit_profile' %} ">
                    <svg class="fill-black text-2xl" width="32 " xmlns="http://www.w3.org/2000/svg " viewBox="0 0 640 512"><!-- Font Awesome Pro 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) --><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 422.4V464c0 26.5 21.5 48 48 48h274.9c-2.4-6.8-3.4-14-2.6-21.3l6.8-60.9 1.2-11.17.9-7.9 77.3-77.3c-24.5-27.7-60-45.5-99.9-45.5zm45.3 145.3l-6.8 61c-1.1 10.2 7.5 18.8 17.6 17.6l60.9-6.8 137.9-137.9-71.7-71.7-137.9 137.8zM633 268.9L595.1 231c-9.3-9.3-24.5-9.3-33.8 0l-37.8 37.8-4.1 4.1 71.8 71.7 41.8-41.8c9.3-9.4 9.3-24.50-33.9z "/></svg>
                </a>
            </div>
        </div>
    </div>
</div>
{% else %}
    <div>
        <div>
            <div>
                <a href="{% url 'signup' %} ">Sign Up</a>
                <a href="{% url 'login' %} ">Log in</a>
            </div>
        </div>
    </div>
{% endif %} 
{% block script %}
    <script>
        const followSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/' +
            'follow/'
        );

        const tweekSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/' +
            'tweek/'
        );

        const likeSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/' +
            'like/'
        );

        const dislikeSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/' +
            'dislike/'
        );

        {% if conversation %} {% get_chat_user_id conversation request.user.id as userid %} {% endif %}

        const chatSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/' +
            'chat/' +
            '{% if conversation %}{{ userid }}{% else %}0{% endif %}' +
            '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            conversationapp.messages.push(data);
            setTimeout(() => {
                scrollToBottom();
            }, 0);

            if (data.to_user_id == {{ request.user.id }}) {
                notifications_el = document.querySelector('#notifications').innerHTML
                notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
                document.querySelector('#notifications').innerHTML = '<span class="white ">Notifications (' + (notification_count + 1) + ')</span>'
            }

        };

        followSocket.onmessage = function(e) {
            notifications_el = document.querySelector('#notifications').innerHTML
            notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
            document.querySelector('#notifications').innerHTML = '<span class="white ">Notifications (' + (notification_count + 1) + ')</span>'
        };

        likeSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.tweek_owner !== '{{ request.user.username }}') {
                notifications_el = document.querySelector('#notifications').innerHTML
                notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
                document.querySelector('#notifications').innerHTML = '<span class="white ">Notifications (' + (notification_count + 1) + ')</span>'
            }
        };

        dislikeSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.tweek_owner !== '{{ request.user.username }}') {
                notifications_el = document.querySelector('#notifications').innerHTML
                notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
                document.querySelector('#notifications').innerHTML = '<span class="white ">Notifications (' + (notification_count + 1) + ')</span>'
            }
        };

        tweekSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            body = data.body
                //check if the user is tagged in the tweek
            if (body.includes("@{{ request.user.username }} ")) {
                notifications_el = document.querySelector('#notifications').innerHTML
                notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
                document.querySelector('#notifications').innerHTML = '<span class="white ">Notifications (' + (notification_count + 1) + ')</span>'
            }
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            document.querySelector("#chatcontainer ")
            try {
                conversationapp.messages.push(data);
                setTimeout(() => {
                    scrollToBottom();
                }, 0);
            } catch {}
            if (data.to_user_id == {{ request.user.id}}) {
                notifications_el = document.querySelector('#notifications').innerHTML
                notification_count = parseInt(notifications_el.split('(')[1].split(')')[0])
                document.querySelector('#notifications').innerHTML = '<span class="white ">Notifications (' + (notification_count + 1) + ')</span>'
            }

        };
    </script>
{% endblock %}